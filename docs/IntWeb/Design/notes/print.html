<h2>Using the GDK Print Interface</h2>

<h3>What we'd like to do</h3>
<p>This is quite simple really:
<ul>
<li>Drive the operation from a dialog like the current (which as based on output to a file).  There is also a direct print option which is thought to send a screenshot to the printer without any great user interaction, which looks like a good thing to review.
<img src="Design/notes/print_dialog.png">
<li>Provide options for png, pdf and poscritpt output formats: bitmaps are quite useful for slides and PDF much better for publications
<li>Use a common API for screen and printer (vector <i>and</i> raster images).
<li>Allow the choice of screenshot (visible features only) whole sequence (include stuff off screen)
We need to choose how to handle detail at higher zoom: PDF and PS formats could handle this at the cost of a slow performance with high volume data , but there is an arguement for only printing what the user can see: ZMap does not display hidden features.
</ul>
</p>

<h3>A brief overview of the GTK and Cairo documentation and interface</h3>
<p>There is a GTK API used to drive printing, which is assumed to be based on choosing printer and orientation etc. but we already have a dialog programmed which is very close to what we want.
The GTKPrintOperation thing requires you to call gtk_print_operation_run() which will operate a dialog for you and emit signals such as ::draw_page which you are supposed to catch and then call functions to drive the API that actually feeds the printer.
It may be much simpler to save screenshot to a (temporary) file and the print the file.
</p>
<p>Cairo docs can be found near <a href="http://www.cairographics.org/documentation/using_the_postscript_surface/">this useful link</a>.
What's interesting is that the same API can drive PNG and PDF and PS file formats as well as screen graphics.
</p>

<p>Other than the scale bar and the mark all the GDK interface in Zmap is encapsulated in CanvasFeaturesets and only a few GDK calls are used.
</p>
<h3>What needs to be done in ZMap</h3>
<h4>Encapsulate all remaining graphics code</h4>
<p>We wish to avoid making major changes to the foo canvas (which uses gdk_ functions to paint the screen) and to make ZMap have control over how things are drawn we need to implement non-Foo code for the scale bar and the mark, and possible also for conatiner backgrounds, if these are drawn.  We may also have to recode the ruler in case there are any interaction between gdk and cairo.
</p>
<p>The scale bar can be coded as a new type of CanvasFeatureset item - it can respond to zoom using existing practices and fits neatly into a column display.
</p>
<p>The mark and ruler are slightly harder to deal with as they cover the whole screen and overlay everything else.  Exisiting Foo Canvas and ZMap code handles z-order explicitly via background, and overlay feature and underlay lists, which are implemented at all layers of container.  The mark is drawn as two (or three) foo canvas rectangles using a stipple pattern, and these are added to the block overlay list - all the columns in a block appear underneath this as containers in the block's features list.  The ruler (in two guises - ruler and mark adjuster) are held directly by the window and are created as children of the canvas root group  - this is using code in zmapDraw.c.  The ruler tooltip is also implemnented as a foo group on the canvas root.
Other than this zmapDraw.c appears to be maily code that has fallen out of use, except for two call from zmapWindowDNAChoose.c, which could be handled by existing sequence highlight code.
</p>
<p>The canvas featureset code implements basic graphics objects such as lines and boxes with clipping, and other items (not clipped) such as poly-lines (for wiggle plots) and glyphs (as gdk_polygons, lines, arcs etc).  Note that clipping os only an issue for long items at high zoom, in case the Foo Canvas coordinate system wraps round.  Drawing overflow is clipped by the X-window code (or gdk).  These do not handle stipple patterns.
</p>
<p>The obvious course of action (given that we wish to simplify the containers code) is to recode the mark as being part of the canvas root group and size it to according to the relevant block if this is less than the screen size.  Ruler and tooltip items will have to be 'raised to top' in Foo Canvas terms.  However to encapsulate the drawing code outside the foo canvas we will have to implement a CanvasFeatureset like object covering the the whole screen and appearing on top of the other objects.
</p>

<h4>Replace all gdk_ drawing calls with cairo functions</h4>
<p>This should be 'simple' but we need to factor in some differences such as the fact that by default lines in cairo are two pixels wide and centred on the gap between two pixels.  We would be wise to be skeptical about
<a href="http://lists-archives.com/gtk/12263-performance-of-many-widgets.html">performance</a>:
<pre>
 I tried here and on a Ubuntu 10.10 install on a recent macbook with
> the Ambiance theme your example was rather slow. There was an
> appreciable delay (0.5s? something like that) between pressing the
> top-left button and the display updating.
>
> I tried running under callgrind and it does seem to be spending a lot
> of time somewhere deep inside libcairo (the graphics library that gtk
> uses to draw the screen). I don't have a dbg version of cairo handy to
> dig deeper.
</pre>
</p>
<p>The cairo drawing API comes from a universe different from GDK and is probably not aimed at drawing large numbers of simple boxes, here's an example of <a href="http://www.gnomejournal.org/article/34/writing-a-widget-using-cairo-and-gtk28">how to implement a widget</a>.
</p>


<h4>Interface the print display to the drawing code</h4>
<p>This should also be simple as we just "create a drawable object (for file/ printer output) and pass this to the existing drawing code".  However in Blixem this has been done by generating a pixmap using gdk_ code and then using cairo to print it, which precludes generating a crisp PDF image.   Referring to the comments above about 'performance skepticism' we may need to implement graphics functions that use gdk or cairo depending on the context.
</p>

<h4>Decisions</h4>
<ul>
<li>allow hidden detail?
<li>dump to file only or print directly as well?
<li>implement the mark as a window feature rather than a block feature?
<li>replace gdk with cairo or run in parallel?
</ul>
<p>


