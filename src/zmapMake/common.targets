#
# common targets that all ZMap makefiles must include for our recursive make
# sytem to work.
#


#
# COMMON TARGETS
#
# These targets expect the various CURRENT_xxx macros they use to have been
# set, otherwise they just won't work... (for now we set CURRENT_AR automatically
# as this seems ok).
#

# note brackets so we get construct of:     libXXXX(nn.o yyy.o xxx.o)
CURRENT_AR = $(CURRENT_LIB)($(CURRENT_OBJ))

all : makebindir $(CURRENT_SRC) $(CURRENT_LIB)
	@echo "$(CURRENT_LIB) successfully made..."

#$(CURRENT_LIB) : $(CURRENT_AR)
$(CURRENT_LIB) : $(CURRENT_DEP) $(CURRENT_OBJ)

$(CURRENT_AR) : $(CURRENT_DEP) $(CURRENT_SRC)

$(CURRENT_SRC) : forcemake
	@$(TEST) -L $(BINDIR)/$@ || ln -s `pwd`/$@ $(BINDIR) 

clean :
	cd $(BINDIR) ; rm -f $(CURRENT_SRC)
	true ; $(CURRENT_REMOVE)
	$(AR) -d $(CURRENT_LIB) $(CURRENT_OBJ)
	@echo "$(CURRENT_OBJ) removed from $(CURRENT_LIB)"



# There seems like a bootstrapping problem here in that the include below won't
# happen unless the "depend" target below has run but it can't run because the
# the include won't work. But in fact it all works as long as there is a file
# there, it can be an empty file but it must be there and this is what the
# "depend" target in the base directory does: make sure the file exists !
# We remove the backup copy that makedepend automatically makes because it takes
# up lots of space and we will have one for every platform...
depend :
	@$(TEST) -w $(MAKEDEPEND_FILE) || chmod u+w $(MAKEDEPEND_FILE)
	makedepend -f$(MAKEDEPEND_FILE) -- $(CFLAGS) -- $(CURRENT_SRC)
	rm -f $(MAKEDEPEND_FILE).bak

include $(MAKEDEPEND_FILE)


#
# include some targets needed by all levels of make.
#
include $(MAKE_DIR)/common.base_targets
