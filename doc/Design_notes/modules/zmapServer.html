<h2> zmapServer - thread based external interfaces </h2>
<fieldset> <legend>Summary</legend>
<h3>Modules</h3>
<p>The zmapServer module exist to provide concurrent thread base interfaces to external databases.  It uses the zmapThread module.
</p>
--- put this in a table and extend ---<br />
zmapServerProtocolHandler is the front end that is used by zmapView etc to request data.<br />
zmapServer interfaces between zmapServerProtocolHandler and the thread base servers.<br />
acedb/, DAS, and pipe/ are the servers that run in these threads.
<br />
<br />

<h3>Related pages</h3>
<p><a href="Design_notes/modules/zmapView.shtml#reqdata">zmapView</a> contains some notes about requesting data from pipeServer modules and other issues.</p>
<p><a href="Design_notes/modules/pipeServer.shtml">pipeServer</a> details usage of that module.</p>
<p><a href="Design_notes/notes/slaveThread.shtml">Threads</a> some notes about thread startup and shutdown.</p>
</fieldset>

<fieldset><legend>Servers and Threads</legend>
<p>Traditionally with a single ACEDB server this will have been kept active with ZMap and ZMap would not run without it. With the advent of pipeServers being used to request data on demand it becomes necessary to have threads startup, run and then be cleared up,  a function that has been planned but not implemented.  There is code to kill off threads on shutdown, but the threads code does not include a clean exit!</p>
<p>Tasks that need doing include:
<ul>
<li>documenting the threads/ slave/ server/ view interactions
<li>implementing a clean shutdown in a slave thread / server
<li>clearing up threads data cleanly
<li>clearing up view-&gt;connection data
</ul>
</p>

</fieldset>

<fieldset><legend>Specifying coordinates</legend>
<p>The server protocol as implemented and used with ACEDB specifies coordinates based from 1 for the region of chromosome stored in an ACEDB and there is currently no way to specify chromosome coordinates (or chromosome, or species) in ZMap.  This leaves some implementation difficulties for pipes in that each pipe is specified as a URL with GET parameters giving this information (ie defined statically and externally).  To request a subset of the the whole alignment it is necessary to request this in ZMap coordinates ie based from 1 and covering the implied sequence range.
</p>
<p>Data is normally requested using coordinates 1,0 and this specifies 'the whole sequence'. Subsets of the whole sequence may be requested by coordinats relative to the local sequence based from 1.
</p>
<h3>Coordinates in the server protocol</h3>
<p>There are some legacy issues with this in that sequence coordinates are specified by some feature context data supplied to the server at some point in the request process after the server has bee created and opened.  As a pipe server is regarded as a script that simply provides a GFF stream there is no interaction with the server protocol as defined for ACEDB after starting the script (and this is not desired as it would introduce needless complexity).  To ensure compatability with previous code the server will still be given a context with a block with the requested r=coordinates and these will also be included in the request URL.
</p>
<h3>Data retrieval process</h3>
<p>Both ACEDB and pipe servers process GFF data and create populated featureset data structures held in a GFF parser data structure while reading the data stream.  Subsequently in another server protocol function these featuresets are added to a feature context block supplied by the ZMap application.
</p>
<p>This is problematical as:
<ul>
<li> The model is that the server provides a feature context as requested and then this feature context is merged into a ZMap view's feature context and it's odd for ZMap to provide part of this.
<li> The supplied feature context block is the mechanism for specifing coordinates <i>after</i> the request for data has been fulfilled.
<li> There is no way to access the 'request block' from the server protocol code or data
<li> The protocol as defined does not include a mechanism to specify requested data coordinates; this is curently achieved by incidental features of the data.
</ul>
Note also that due to the layering of the server protocol code there is no way to pass data which is global to ZMap (eg request coordinates for several servers) to an individual server - if needed it must be duplicated.
This is because the ZMap server data structure contains a pointer to a server specific structure and it is the latter that is passed to the thread specific code.
</p>

<h3>Chromosome coordinates</h3>
<p>There is a need to display chromosome coordinates (to allow users to communicate with others) and currently these are extracted from the sequence name.
</p>
<p>It should be possible to specify species chromososme and seqeuence coordinates to pipe server scripts and still present ZMap style (based from 1) coordinates to the user (which is useful as chromosome coordinates are too big and ZMap coordinates give some sense of scale.
</p>
<p>
For a given session these can be specified in a stanza in the ZMap configuration, or given in the main window.
Refer to <a href="Design_notes/notes/coord_config.shtml">Coordinate systems and configuration</a> for further notes.
</p>
<p>Coordinates can also be given via xremote and if so will override any given in configuration files.  For example the new_view command requests a new ZMap window and gives start and end coordinates.  Some conventions have been agreed relating to sequence names and coordinates:
<ul>
<li>for old style config the sequence name will be like 'chr4-04_210623-364887' and start and end coordinates based from 1.
<li>when using chromosome coordinates the sequence name will not hold coordinates (eg 'chr-4_04'  and the starn and end corrdinates will be chromosome based.
</ul>
</p>
<h4>A gotcha</h4>
<p>If configures with chromosome coordinates and an xremote command is recieved with 1 based coordinates (eg 1,0 for the whole sequence) then due to the existing context-block based mehtod of specifying coordinates ZMap will switch to 1-based coordinates and this causes some confusion.  Data ought to be clipped if outside the sequence region as configured but as the coordinate range gets reset by legacy code it is not.  To have ZMap handle out of range data correctly it is essential that correct coordinates are given in data requests (ie not 1,0). This is regarded as a transitional issue and should be verified once otterlace+ zmap is working fully based on chromsome coordinates.
</p>

</fieldset>