<!-- $Id: zmapWindowColConfig.html,v 1.2 2010-11-19 15:55:41 mh17 Exp $ -->
<h2>Column Config Window - interface to pipe servers</h2>
<fieldset><legend>Background</legend>
<h3>Deferred loading of columns</h3>
<p>Historically ACEDB could define some columns for deferred loading (via a style) and these would not be requested in the initial data load.  The columns dialog could be used to request these, and also to specify an address range via the mark.  This implies the possibility of patchwork coverage of any column but it is not clear how much information would have been stored regarding the ranges requested.
</p>
<p>More recently Otterlace has provided a post startup 'load columns' dialog  and this is used to request data over the whole address range for selected columns.

</p>
<p>Deferred styles have been removed and it is intended to allow ZMap to request data from (pipe) servers as configured via the columns dialog - this will allow similar functionality as within the Otterlace context while running in standalone mode.   It has been suggested that the load and display panes can be combined although this would require a re-arrangement as the display pane works by strand.  It is also worth noting that GTK positions widgets automatically and it is not always easy to modify existing layouts with sparse buttons.
</p>

<p>Note also that display is traditionally done by column yet data is requested nominally by featureset
</p>

<p>To provide RNAseq data it is also necessary to implement a more complicated request interface as defined <a href="Design_notes/notes/RNAseq.shtml">here</a>.
</p>
</fieldset>

<fieldset><legend>User Interface</legend>
<p>
The display options for each column are show hide and auto - note that auto is not a default setting but instead 'show according to zoom level' and three radio buttons are needed for these options for each strand.
</p>
<p>
For loading, each column will have a tick box to load data which will be selected and disabled if data for the full sequence is present.  If partial data has been loaded (eg from the mark previously) then this tick box will be presented as de-selected unless selected by the user.
</p>
<p>
Requesting from the mark will always be possible if full sequence data is not present and ZMap will maintain a list of regions loaded and optimise the user's requests.  Whatever regions that have been loaded will not be presented - the users can look at the ZMap display to find out and if necessary columns can have background colours to show 'not loaded' status.
There will be an option to load all selected colums fully or to load all selected columns from the mark; combinations of this will not be possible in one operation.  This will provide a simpler interface, w=the assumption being that user will load columns en masse on startup and from the mark when they have some specific task in mind.
</p>
<p>
Buttons will be provided to:
<ul>
<li> select all forward strand
<li> select all reverse strand
<li> de-select all forward strand
<li> de-select all reverse strand
<li> auto all
<li> revert/cancel (show current state)
<li> display selection (apply)
<li> select all for load
<li> (not provided: de-select all for load - this is revert/cancel)
<li> load selected
<li> load selected from mark
</ul>
</p>

<h3>Implementation</h3>
<p>Display and load buttons will be generated by separate functions, to allow these to be combined onto one pane or split into two easily.  Initially the load functions will be implemented on a separate pane, to provide extra function with minumum effort.
</p>
<p>
On requesting a column to be loaded ZMap will initiate requests for all the featuresets that map to that column.
</p>
<p>It would of course be possible to supply controls for each featureset but this will not be implemented initially as a) it would require much more coding of user interface with very little benefit to the user and b) it would make the user interface very complicated - there are hundreds of featuresets defined and it is unlikely that users will want this level of control.  RNAseq data is perhaps different and a <a href="Design_notes/notes/RNAseq.shtml">custom control interface</a> for that has been suggested.</p>
<h3>A sample layout</h3>
<p>
Here's the existing layout:<br />
<img src="Design_notes/modules/col_config.png" class="img" alt="a picture of the dialog box"><br />

Here's a sample layout in text, to be replaced with a real picture when implemented.
<pre>
Trembl             Load [x]
Swissprot          Load [x]
Das_Phast_117      Load [x]

      [ Select All ] [Load Selected ]
      [ Select None] [Load from Mark]
</pre>
</p>
</fieldset>




<fieldset><legend>Loading data</legend>

<h3>How to tell if a column is loaded fully or in the mark</h3>

<p>There appears to be a data structure allocated per block and per column which has some kind of bitmap (<b>zmapSeqBitmap.c</b>)that relates to whether or not features are loaded in various regions - this was used for deferred styles in the past and interacts with the mark.  The good news is that this is only used by <b>zmapWindowContainerBlock.c</b> and that the wrapper functions that use it are only used in <b>zmapWindowDrawFeatures.c</b>  <b>zmapWindowColConfig.c</b>, and <b>zmapWindow.c</b> in code handling deferred columns.  This would be quite simple to replace or change.
</p>
<p>Deferred styles code has been #iffed out and it may be appropriate to remove or modify this bitmap code as well but it is necessary to check where it is used.
</p>
<p>The deferred style code assumes that columns are always present even if there is no data and this is no longer valid as columns are only created if features are to be displayed in them.
</p>

<h3>Required function<h3>
<h4>Load Featuresets or columns?</h4>
<p>Data is requested by featureset - necessarily pipe servers are not connected with display columns and the featureset to column mapping is provided by ZMap configuration or historically by ACEDB.  There is currently no mechanism to show or hide a featureset distinct from a column and display options operate on columns and forward and reverse strands operate independantly.  This shows that the users will expect to deal with columns and not featuresets.  RNAseq data may be an excpetion but as mentioned above a separate interface will be provided for that. Therefore we will present the user the option to load columns and not featuresets.
</p>
<p>This presents a problem in that if the featureset to column mapping and the server configuration results in a column that has some but not all of its featuresets loaded then we have to allow the remainder to be loaded, and possibly allow selection of which ones. This is potentially tricky as some columns may have large numbers of obscure featuresets attached.  Servers can also fail and this issue cannot be configured away.
</p>
<p>Columns will be flagged as loadable as long as there is data missing and each time we request all the data that is not yet present, limiting to the mark if relevant.
</p>

<h4>Server or featureset status</h4>
<p>Servers are configured as delayed or not and delayed ones (in fact all servers) need a loaded flag.
It may be easiest to re-implement the block/ column bitmap indicating loaded status in the server. Alternatively this information can be stored in the featuresets data in the features context. Note that although most pipe servers return a single featureset some (eg Repeats) return several and ACEDB certainly does. However, these featuresets will always be requested in tandem as we no longer have the defererred styles as provided by ACE.
</p>
<p>Given that server requests can fail this implies that a column may be considered loaded partially, and also over some sub-sequence region if data is requested from the mark.
</p>
<p>The columns config dialog must be able to query this.
</p>
<p>Current code updates the zmapSeqBitmap when features are displayed, which is not optimal - the user could conceivably set the column to 'Hide' and then request that data be loaded (possibly this may be prevented by the dialog code but if so it's not future-proof). (This may be a follow-on from loaded status formerly being held in the styles).
</p>

<h4>Handling column load requests</h4>
<p>As a single server can provide multiple featuresets which can be configured into different columns (unlikely in practice, but software has to be rugged) it will be better to store loaded status per featureset. When the user requests that a column be loaded then if a contained featureset is not present or not covering the mark then the relevant server will be found and a request queued.  Each featureset in the returned context will be processed by the mergeContext function and a list of loaded regions maintained. For simplicity, a fully loaded column will have a single sequence region in this list covering the whole sequence.
</p>

<h3>Possible future modifications</h3>
<p>The above defines a user interface based on previous versions of ZMap and we need to consider how potential future requirements may be affect by the data structures and implementation chosen.

<h4>Requesting individual featuresets rather than columns</h4>
<p>
Loaded status and column loading will operate as is. The change needed would be a bigger user interface.
</p>

<h4>Requesting data from multiple blocks</h4>
<p>Some work was done on this in the past with the intention of being able to explore big genes and re-arranged regions.  Current code work on the basis of requesting within the current block only and this seems to be reasonable.  Featureset loaded status should be TRUE if the current block is covered, which implies a slightly more specific implemntation than would be ok for a single block, single alignment use.
</p>

<h4>Bolting on an RNAseq front end</h4>
<p>We hope that impmenting a request module will result in code that can be used by new dialogs without modification.  RNAseq data is not yet fully defined in Zmap terms, but we assume that we must be able to request individual featuresets for specific regions, which is covered by the above.  There may be a requirement to hide or show an individual featureset within a column, which is not relevant here.
</p>

<fieldset><legend>Tasks Summarised</legend>
<p>To implement the above:
<ul>
<li> Remove the zmapSeqBitmap module and replace with a GList of sequence coordinate pairs held in the FeatureContext featureset structures. This is to be updated by the View mergeContext functions. zmapGFF2Parser.c must also be modified to provide similar lists for the data it receives - this will cover the initial feature context, which is not merged and also provide raw data for the merged context's lists.
<li> <b>I got to here</b> nned to verfiy the loaded lists merge function which is boringly complex
<li> Replace the functions in zmapWindowContainerBlock.c that use zmapSeqBitmap.
<li> Renovate the deferred columns pane in the columns config dialog.
<li> Provide functions to fire off requests from a given column request according to loaded status. Modify the server code to set the start and end coordinates in the request URL prropriately and store these in the server data structures.
<li> Map marked region feature coordinates to full sequence in zmapGFF2parser.c

</ul>
<p>
</fieldset>
